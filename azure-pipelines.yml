# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  # dockerRegistryServiceConnection: '623b5260-cd2f-4392-bf7b-0aba7c30852f'
  imageRepository: 'reactapprepo'
  containerRegistry: 'aksforgecontainerregistry.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

  stages:
    - stage: Build
      displayName: Build and push Docker Image
      jobs:
      - job: Build
        displayName: Build job

      steps:
      - task: Docker@2
        inputs:
          containerRegistry: 'ACRserviceprinciplenew'
          repository: 'nextjs-app1'
          command: 'buildAndPush'
          Dockerfile: '**/Dockerfile'
          tags: |
            latest
            $(Build.BuildId)
      
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/kube-manifests/'
          Contents: |
            deployment.yml
            service.yml
          TargetFolder: '$(Build.ArtifactStagingDirectory)'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'